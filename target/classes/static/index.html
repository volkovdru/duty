<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление пользователями</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .user-card { transition: transform 0.2s; cursor: pointer; }
        .user-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .form-container { max-width: 600px; margin: 0 auto; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const apiService = {
            async getUsers() {
                const response = await fetch('/api/users');
                if (!response.ok) throw new Error('Ошибка загрузки пользователей');
                return response.json();
            },
            async createUser(user) {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(user)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    if (errorData && typeof errorData === 'object') {
                        const errorMessages = Object.values(errorData).join(', ');
                        throw new Error(`Ошибка валидации: ${errorMessages}`);
                    }
                    throw new Error('Ошибка создания пользователя');
                }
                return response.json();
            },
            async updateUser(id, user) {
                const response = await fetch(`/api/users/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(user)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    if (errorData && typeof errorData === 'object') {
                        const errorMessages = Object.values(errorData).join(', ');
                        throw new Error(`Ошибка валидации: ${errorMessages}`);
                    }
                    throw new Error('Ошибка обновления пользователя');
                }
                return response.json();
            },
            async deleteUser(id) {
                const response = await fetch(`/api/users/${id}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Ошибка удаления пользователя');
                return true;
            }
        };

        function UserList({ users, onUserClick, onDeleteUser, onAddUser }) {
            const [searchTerm, setSearchTerm] = useState('');
            const filteredUsers = users.filter(user => 
                user.firstName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                user.lastName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                user.position.toLowerCase().includes(searchTerm.toLowerCase())
            );

            return (
                <div className="container mt-4">
                    <div className="d-flex justify-content-between align-items-center mb-4">
                        <h2>Список пользователей</h2>
                        <button className="btn btn-primary" onClick={onAddUser}>
                            Добавить пользователя
                        </button>
                    </div>
                    
                    <input
                        type="text"
                        className="form-control mb-3"
                        placeholder="Поиск..."
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                    />
                    
                    <div className="row">
                        {filteredUsers.map(user => (
                            <div key={user.id} className="col-md-6 col-lg-4 mb-3">
                                <div className="card user-card" onClick={() => onUserClick(user)}>
                                    <div className="card-body">
                                        <h5 className="card-title">
                                            {user.lastName} {user.firstName} {user.middleName}
                                        </h5>
                                        <p className="card-text">
                                            <strong>Должность:</strong> {user.position}<br/>
                                            <strong>Дата рождения:</strong> {new Date(user.birthDate).toLocaleDateString('ru-RU')}
                                        </p>
                                        <button 
                                            className="btn btn-danger btn-sm"
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                if (confirm('Удалить пользователя?')) {
                                                    onDeleteUser(user.id);
                                                }
                                            }}
                                        >
                                            Удалить
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function UserForm({ user, onSave, onCancel }) {
            const [formData, setFormData] = useState({
                firstName: user?.firstName || '',
                lastName: user?.lastName || '',
                middleName: user?.middleName || '',
                birthDate: user?.birthDate ? user.birthDate.split('T')[0] : '',
                position: user?.position || ''
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <div className="container mt-4">
                    <div className="form-container">
                        <h2>{user ? 'Редактирование пользователя' : 'Новый пользователь'}</h2>
                        
                        <form onSubmit={handleSubmit}>
                            <div className="row">
                                <div className="col-md-4 mb-3">
                                    <label className="form-label">Имя *</label>
                                    <input
                                        type="text"
                                        className="form-control"
                                        value={formData.firstName}
                                        onChange={(e) => setFormData({...formData, firstName: e.target.value})}
                                        required
                                    />
                                </div>
                                
                                <div className="col-md-4 mb-3">
                                    <label className="form-label">Фамилия *</label>
                                    <input
                                        type="text"
                                        className="form-control"
                                        value={formData.lastName}
                                        onChange={(e) => setFormData({...formData, lastName: e.target.value})}
                                        required
                                    />
                                </div>
                                
                                <div className="col-md-4 mb-3">
                                    <label className="form-label">Отчество</label>
                                    <input
                                        type="text"
                                        className="form-control"
                                        value={formData.middleName}
                                        onChange={(e) => setFormData({...formData, middleName: e.target.value})}
                                    />
                                </div>
                            </div>
                            
                            <div className="row">
                                <div className="col-md-6 mb-3">
                                    <label className="form-label">Дата рождения *</label>
                                    <input
                                        type="date"
                                        className="form-control"
                                        value={formData.birthDate}
                                        onChange={(e) => setFormData({...formData, birthDate: e.target.value})}
                                        required
                                    />
                                </div>
                                
                                <div className="col-md-6 mb-3">
                                    <label className="form-label">Должность *</label>
                                    <input
                                        type="text"
                                        className="form-control"
                                        value={formData.position}
                                        onChange={(e) => setFormData({...formData, position: e.target.value})}
                                        required
                                    />
                                </div>
                            </div>
                            
                            <div className="d-flex gap-2">
                                <button type="submit" className="btn btn-primary">Сохранить</button>
                                <button type="button" className="btn btn-secondary" onClick={onCancel}>Отмена</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function App() {
            const [users, setUsers] = useState([]);
            const [currentView, setCurrentView] = useState('list');
            const [currentUser, setCurrentUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            const loadUsers = async () => {
                try {
                    setLoading(true);
                    setError(null);
                    const data = await apiService.getUsers();
                    setUsers(data);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                loadUsers();
            }, []);

            const handleUserClick = (user) => {
                setCurrentUser(user);
                setCurrentView('form');
            };

            const handleAddUser = () => {
                setCurrentUser(null);
                setCurrentView('form');
            };

            const handleSaveUser = async (userData) => {
                try {
                    setLoading(true);
                    setError(null);
                    
                    if (currentUser) {
                        await apiService.updateUser(currentUser.id, userData);
                    } else {
                        await apiService.createUser(userData);
                    }
                    
                    await loadUsers();
                    setCurrentView('list');
                    setCurrentUser(null);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleDeleteUser = async (userId) => {
                try {
                    setLoading(true);
                    setError(null);
                    await apiService.deleteUser(userId);
                    await loadUsers();
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleCancel = () => {
                setCurrentView('list');
                setCurrentUser(null);
                setError(null);
            };

            if (loading && users.length === 0) {
                return (
                    <div className="text-center mt-5">
                        <div className="spinner-border text-primary" role="status">
                            <span className="visually-hidden">Загрузка...</span>
                        </div>
                        <p className="mt-2">Загрузка пользователей...</p>
                    </div>
                );
            }

            return (
                <div>
                    {error && <div className="alert alert-danger m-3">{error}</div>}
                    
                    {currentView === 'list' ? (
                        <UserList
                            users={users}
                            onUserClick={handleUserClick}
                            onDeleteUser={handleDeleteUser}
                            onAddUser={handleAddUser}
                        />
                    ) : (
                        <UserForm
                            user={currentUser}
                            onSave={handleSaveUser}
                            onCancel={handleCancel}
                        />
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html> 